---
title: "Data Science for the Natural Environment (FA21)"
subtitle: "BI449 Data Science for the Natural Environment"
author: "Shannon J. O'Leary"
date: "`r Sys.Date()`"
knit: "bookdown::preview_chapter"
output:
  msmbstyle::msmb_html_book:
    highlight: tango
    toc: TRUE
    toc_depth: 1
    split_by: chapter
    margin_references: FALSE
    css: msmb.css
bibliography: labmanual.bib
link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}

library(msmbstyle)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(tidy = FALSE, 
                      cache.extra = packageVersion('msmbstyle'),
                      warning = FALSE,
                      message = FALSE)


options(htmltools.dir.version = FALSE)

source("scr/ggplot.R")

```

# Phenology

**Learning Objectives**

After completing this tutorial you should be able to

* formulate meaningful questions based on a given data set
* run a linear regression analysis using the `tidymodels` framework
* understand potential impacts of climate change on the phenology of species


Download the [05_Phenology](https://drive.google.com/drive/folders/19GD1COEgPPfjtXrfzKFoLodzdH0a-v68?usp=sharing) project folder. Once you have downloaded it, unzip the project directory into your `BI449` directory. 

To get some practice setting up your own project files, you might notice that this one does not yet have an `Rproj` file or any `Rmarkdown` files in it. So the first thing we want to do is create a new R project. To do this open `Rstudio` then use the dropdown menu in the top right corner to select `New Project` and from there `New Project in an existing directory`. From there, navigate to and select the project folder create an R project.

Open a new `Rmd` file using `File > New File > R Markdown` or the drop down menu of the green plus button below `File` and save it in your Exploratory Analysis project directory. That's right - training wheels are off ... you will need to add all of your own headers, plain text etc. Set up the `YAML` header so that you are the author and when knitted the date will reflect the date of the creation of the document.

Recall that you can use the initial setup chunk to set some of your preferred formatting by determining global settings for the document. One helpful setting we discovered is to turn off warnings, errors, and messages being printed out in the knitted html document.

Another helpful setting is to define a default theme for your plots. You can do this using `theme_set()`. So for example, you could set a default theme like so: `theme_set(theme_bw())`. Choose your favorite theme (or try a new one) for this homework assignment.

Remember, you should always check your `html` document after it knits to make sure that everything has converted as expected, including your figures, bullet points etc. 

Let's load our packages so we can get started. 

```{r}

# load libraries
library(tidyverse)
library(janitor)
library(skimr)
library(patchwork)
library(lubridate)
library(knitr)

# turn of sci notation
options(scipen=999)

```


## Introduction to phenology

`r msmbstyle::question_begin(label = "ques:phen-1")`

Briefly define the terms phenology, phenophases, life history and life history traits and argue how you think climate change might impact these.

`r msmbstyle::question_end()`

We are going to explore a data set that contains information on the phenology of Minnesota Species to determine to which extent seasonal events are tied to climate or whether they are dependent on other factors. To do this we are going to use a data set generated by the [Minnesota Phenology Network](https://mnpn.usanpn.org/).

`r msmbstyle::question_begin(label = "ques:phen-2")`

Go to the Minnesota Phenological Network's website and explore the short introductory and history statements in the "Home" and "About" sections. Check out the "Meet the species" page that presents Minnesota's seven superstar species. Get to know them in the "Read more" sections. 

Pick two of the seven superstars and list the specific phenophases that associated with the species.

`r msmbstyle::question_end()`

## Explore the data set

We are going to use data from the Minnesota Phenology Network to explore how climate change might be impacting the phenology of species.

```{r}

pheno <- read_delim("data/mnpn_master_dataset_2018.v2.txt", delim = "\t") %>%
  clean_names()

```

`r msmbstyle::question_begin(label = "ques:phen-3")`

Let's get an overview of the data set. Use your exploratory analysis skills to get an idea of the dimensions of the data set, what variables are contained in the data set and what data types they are. What function can you use?

Write a brief description of the data set.

`r msmbstyle::question_end()`


`r msmbstyle::solution_begin()`

That's right - `skim()` will give you all the information in one handy place!

```{r}

skim(pheno)

```

You still have to write your description though ...

`r msmbstyle::solution_end()`

One thing you may have noticed is that we have a column `day` that contains the data - however, currently it is formatted as a `character`. This could cause issues down the line when we want to plot things. 

Dates are notoriously difficult to deal with^[just think of the many, many, many ways we can write a date and how conventions might differ between fields and countries!]. A useful package to deal with dates is `lubridate`. 

Let's use functions from that package to create column called `data` that has the data type date, and while where at it learn how to create new columns with the month and day.

```{r}

pheno <- pheno %>%
  mutate(date = mdy(day),            # converts character in format month day year to date
         month = month(date),        # extract month
         day = day(date))            # extract day


```

Now let's get an idea on what data is contained in the data set. 

`r msmbstyle::question_begin(label = "ques:phen-4")`

How can you use the `skimr` output to determine how many unique entries (categories) we have for our categorical variables?

What function could you use to determine what life forms, groups of species, and counties are contained in the data set?

`r msmbstyle::question_end()`

`r msmbstyle::solution_begin()`

The `dplyr` verb that can help you out here is `distinct()` - go ahead and create those tables.

`r msmbstyle::solution_end()`

`r msmbstyle::question_begin(label = "ques:phen-5")`

Create a table that shows the number of species in each group of species.

`r msmbstyle::question_end()`

Let's focus on woody plants for now.

`r msmbstyle::question_begin(label = "ques:phen-6")`

Create a new object called `woody` that contains only woody plants.

`r msmbstyle::question_end()`

```{r echo=FALSE}

woody <- pheno %>%
  filter(group == "WOODY")

```

`r msmbstyle::question_begin(label = "ques:phen-7")`

Determine what events are recorded for species in this category. Create an overview table with events organized alphabetically.

`r msmbstyle::question_end()`

That's a lot of events. 

`r msmbstyle::question_begin(label = "ques:phen-8")`

Let's try to get an idea of when these different events occur throughout the year. How could you plot this data? Give it a try!

`r msmbstyle::question_end()`

`r msmbstyle::solution_begin()`

Since we are interested in distributions, you would want to look at histograms or boxplots - this is one way your figure could look like:

```{r fig.height=10, fig.width=7, fig.cap="Distribution of life history events throughout the year for Minnesota woody plants", echo=FALSE}

ggplot(woody, aes(x = day_of_year, y = event)) +
  geom_boxplot(fill = "darkorange") +
  theme_standard

```

`r msmbstyle::solution_end()`

## Formulate a specific question

Since we are interested in whether climate change is impacting phenology, let's chose a specific event that we think is likely to be linked to changes in temperature and could be a good indicator of changing phenology. 

`r msmbstyle::question_begin(label = "ques:phen-9")`

Pick three events that you think could be good indicator events to look at and argue why you think they would be interesting to explore.

`r msmbstyle::question_end()`

Let's use flowering date.

```{r echo=FALSE}

flowering <- woody %>%
  filter(event == "FLOWERING")

```

`r msmbstyle::question_begin(label = "ques:phen-10")`

Create a subset called `flowering` that contains only records of flowering dates for woody plants. How could you plot this data to determine whether the flowering data has changed over time?

Describe how you expect the pattern to look like if the flowering date is occurring earlier, later, or not changing over time.

Plot the data and then use your predicted patterns to assess whether the flowering date is changing over time.

`r msmbstyle::question_end()`


`r msmbstyle::solution_begin()`

This is what you want your figure to look like:

```{r fig.cap="Change in day of flowering for woody plants in Minnesota 1941 - 2018. Fill of individual points indicates the month of the flowering date, Linear trendline is fitted in red.", echo=FALSE}

ggplot(flowering, aes(x = year, y = day_of_year, fill = month)) +
  geom_point(shape = 21, size = 2, alpha = .5) +
  geom_smooth(method = "lm", color = "red") +
  scale_fill_viridis_c() +
  labs(x = "Year", y = "Flowering date") +
  theme_standard +
  theme(legend.position = "bottom")

```

`r msmbstyle::solution_end()`

Let's consider how useful this visualization is for answering our question. We combined all the woody species from all of Minnesota in the same plot. We probably don't expect all the woody plants to react to changes in the same way or for that response to occur at the same pace. We should also consider that there could be differences based on the geographic location.

In this case, it might be more effective to narrow our question and pull out a specific species. Let's use the American Elm (*Ulmus americanus*). This is a deciduous species with a geographic range throughout most of the eastern US and southeast Canada, i.e. Minnesota is at the northern limit of its range. Overall, this is a pretty hardy species that will grow to a considerable size and is frequently found in Urban settings. Like all elm species in Minnesota it is susceptible to the Dutch elm disease which caused by an invasive fungal pathogen.

`r msmbstyle::question_begin(label = "ques:phen-11")`

Create a new object called `elm` that contains only entries for the American Elm.

`r msmbstyle::question_end()`

```{r echo=FALSE}

elm <- flowering %>%
  filter(species_common_name == "AMERICAN ELM")

```

Since the American Elm is so widespread, let's also consider that we might want to eliminate geography as a confounding pattern. 

`r msmbstyle::question_begin(label = "ques:phen-12")`

Determine whether we have data for more than one county. Use that information to determine whether you want (need) to narrow down your data set. Explain your choice.

`r msmbstyle::question_end()`

It appears we have found our question!

`r msmbstyle::question_begin(label = "ques:phen-13")`

State the specific question we are asking and give a brief description of the data you will need and how you will analyze it to answer that question.

`r msmbstyle::question_end()`

`r msmbstyle::solution_begin()`

Just so we are all in agreement - our question is: Has climate change changed the phenology of American Elm in Ramsey County, Minnesota?

But do we already have all the data we need?

`r msmbstyle::solution_end()`


## Determine changes in the flowering date of American elm in Ramsey County, MN

Our first step will be determining whether or not there has been a change in the flowering data of the American Elm.

`r msmbstyle::question_begin(label = "ques:phen-14")`

Make a prediction of how you think the flowering date of the American Elm may have changed over the 50 year time span recorded in our data set. Describe what your figure should look like if you are indeed correct, be specific and argue why you are expecting this pattern.

`r msmbstyle::question_end()`

`r msmbstyle::question_begin(label = "ques:phen-15")`

Filter your data so that it only contains entries for Ramsey Country.

Plot your data to determine if your prediction was correct; add a simple linear trend line to your plot to help identify the overall pattern.

Give your visualization a title and legend and describe your results. Be specific, i.e. consider how much the flowering data has shifted. For your interpretation/discussion identify at least two possible mechanisms that could be causing this pattern.

`r msmbstyle::question_end()`

`r msmbstyle::solution_begin()`

This is what your figure should look like.

```{r fig.cap="Change in flowering data for American Elm in Ramsey Co., MN  (1941 - 1991). Fill of individual points indicates the month of the flowering date, the linear trendline is indicated in red.", echo=FALSE}

elm <- elm %>%
  filter(county == "RAMSEY")

ggplot(elm, aes(x = year, y = day_of_year, fill = month)) +
  geom_point(shape = 21, size = 3) +
  geom_smooth(method = "lm", color = "red") +
  scale_fill_viridis_c() +
  labs(x = "year", y = "flowering date") +
  theme_standard +
  theme(legend.position = "bottom")

```

`r msmbstyle::solution_end()`


## Determine temperature change in Ramsey County

If we want to investigate whether there is a relationship between climate change and change in the flowering date, we need climate data for Ramsey Country for the same time period.

`r msmbstyle::question_begin(label = "ques:phen-16")`

Describe what your climate data set should look like and argue why you want to include certain variables. Describe the pattern you would expect to see in your climate data over time to support your hypothesis of what is driving the pattern you uncovered in the phenology data set. Be specific.

`r msmbstyle::question_end()`

`r msmbstyle::solution_begin()`

Hint: Consider what the ideal temporal and spatial resolution would need to be to "match" your phenology data.

`r msmbstyle::solution_end()`

You ask and you shall receive:

Go to the DNR [Minnesota Climate Trends](https://arcgis.dnr.state.mn.us/ewr/climatetrends/) website to access historical observations for specific Minnesota locations. Use the drop down menus options to select subsets using the check boxes to create a data set that meets the specifications you set out above.

Unfortunately, the download button doesn't work. Instead, you should cut and paste the data into a text editor or excel and save it as a tab-delimited file in your `data` folder. Name it `MN_temp.txt`.

Lets read in your temperature data. Unless you added headers in the text file it's missing them. Similar to the way we can use `skip` if there are additional lines, we have an argument we can use to specify column names if they are missing.

```{r}

temp <- read_delim("data/MN_temp.txt", delim = "\t", col_names = c("year", "temperature"))

```

`r msmbstyle::question_begin(label = "ques:phen-17")`

Plot your data to determine if your prediction was correct; add a simple linear trend line to your plot to help identify the overall pattern.

Give your visualization a title and legend and describe your results. Be specific (i.e. don't just state the overall trend, consider how much temperature has changed). For your interpretation/discussion consider how the data differs from your predictions and determine whether it supports your hypothesis of the mechanism.

`r msmbstyle::question_end()`

`r msmbstyle::solution_begin()`

Here's what your figure could look like:

```{r fig.cap="Change in mean March temperature [Fahrenheit] for 1941 - 1991 (blue) and linear trendline (red)", echo=FALSE}

ggplot(temp, aes(x = year, y = temperature)) +
  geom_line(color = "darkblue", size = 1) +
  geom_point(shape = 21, size = 3, color = "darkblue", fill = "white") +
  geom_smooth(method = "lm", color = "red") +
  scale_fill_viridis_c() +
  labs(x = "year", y = "flowering date") +
  theme_standard +
  theme(legend.position = "bottom")

```

Bonus question: Consider why it might be appropriate to use a line graph for the temperature data but not for the flowering date plot.

`r msmbstyle::solution_end()`


